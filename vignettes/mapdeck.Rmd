---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "# "
)
library(mapdeck)
access_token <- 'pk.eyJ1Ijoic3ltYm9saXgiLCJhIjoiY2pqbm45Zmo1MGl1aTNxbmxwamFqb3Z6MSJ9.yIkj0tGNNh4u61DliOXV6g'
```


### What is Mapdeck?

Mapdeck is a combination of [Mabox](https://www.mapbox.com/help/define-mapbox-gl/) and [Deck.gl](http://deck.gl/#/)


### Why did you build it?

Because Deck.gl is one of the most user-friendly WebGL javascript libraries and can produce some beautiful maps. And it integrates nicely with Mapbox maps. 



### The basics

Simply calling `mapdeck()` gives you a map

```{r, fig.width=6}
mapdeck(token = access_token)
```

You can style the map using any [mapbox style](https://www.mapbox.com/api-documentation/#styles) template styles, or you can [create one of your own](https://www.mapbox.com/help/studio-manual-styles/)

```{r, fig.width=6}
mapdeck(token = access_token, style = 'mapbox://styles/mapbox/dark-v9')
```

### Arcs

```{r, fig.width=6}

key <- "pk.eyJ1Ijoic3ltYm9saXgiLCJhIjoiY2pqbm45Zmo1MGl1aTNxbmxwamFqb3Z6MSJ9.yIkj0tGNNh4u61DliOXV6g"

url <- 'https://raw.githubusercontent.com/plotly/datasets/master/2011_february_aa_flight_paths.csv'
flights <- read.csv(url)
flights$id <- seq_len(nrow(flights))
flights$stroke <- sample(1:3, size = nrow(flights), replace = T)

mapdeck( token = key, style = 'mapbox://styles/mapbox/dark-v9', pitch = 45 ) %>%
	add_arc(
		data = flights
		, layer_id = "arc_layer"
		, origin = c("start_lon", "start_lat")
		, destination = c("end_lon", "end_lat")
		, stroke_from = "airport1"
		, stroke_to = "airport2"
		, stroke_width = "stroke"
	)



```


### Scatter

```{r, fig.width = 6}
key <- "pk.eyJ1Ijoic3ltYm9saXgiLCJhIjoiY2pqbm45Zmo1MGl1aTNxbmxwamFqb3Z6MSJ9.yIkj0tGNNh4u61DliOXV6g"

mapdeck( token = key, style = 'mapbox://styles/mapbox/dark-v9', pitch = 45 ) %>%
add_scatterplot(
  data = capitals
  , lat = "lat"
  , lon = "lon"
  , radius = 100000
  , fill_colour = "country"
  , layer_id = "scatter_layer"
)

```


### Path

Currently only encoded polylines are supported. 

```{r, fig.width = 6}

key <- "pk.eyJ1Ijoic3ltYm9saXgiLCJhIjoiY2pqbm45Zmo1MGl1aTNxbmxwamFqb3Z6MSJ9.yIkj0tGNNh4u61DliOXV6g"

mapdeck(
  token = key
  , style = 'mapbox://styles/mapbox/dark-v9'
  , location = c(145.688269, -38.101062)
  , zoom = 8) %>%
  add_path(
  data = roads
  , polyline = "geometry"
  , stroke_colour = "RIGHT_LOC"
  , layer_id = "path_layer"
)

```

### Polygons

```{r, fig.width = 6}
mapdeck(
  token = key
  , style = 'mapbox://styles/mapbox/dark-v9'
  , location = c(145, -38)
  , zoom = 8
  ) %>%
  add_polygon(
  	data = melbourne
    , polyline = "geometry"
    , layer = "polygon_layer"
  	, fill_colour = "fillColor"
 	)
```


### SF - Polygon

```{r, fig.width=6}
library(sf)
library(geojsonsf)

sf <- geojson_sf("https://symbolixau.github.io/data/geojson/SA2_2016_VIC.json")

mapdeck(
  token = key
  , style = 'mapbox://styles/mapbox/dark-v9'
  ) %>%
  add_polygon(
  	data = sf
    , layer = "polygon_layer"
  	, fill_colour = "SA2_NAME16"
  	)

```


### Multiple layers


```{r, fig.width = 6}

df1 <- capitals[ capitals$country == "Australia", ]
df2 <- capitals[ capitals$country != "Australia", ]
df1$key <- 1
df2$key <- 1

df <- merge(df1, df2, by = 'key')

mapdeck(
  token = key
  , style = 'mapbox://styles/mapbox/dark-v9'
  , pitch = 35
  ) %>%
	add_arc(
		data = df
		, origin = c("lon.x", "lat.x")
		, destination = c("lon.y", "lat.y")
		, layer_id = "arc_layer"
		, stroke_from = "country.x"
		, stroke_to = "country.y"
		, stroke_width = 2
	) %>%
	add_scatterplot(
		data = df2
		, lon = "lon"
		, lat = "lat"
		, radius = 100000
		, fill_colour = "country"
		, layer_id = "scatter"
	)


```


### Shiny

```{r, eval = FALSE}
library(shiny)
library(shinydashboard)
library(mapdeck)
library(data.table)

ui <- dashboardPage(
	dashboardHeader()
	, dashboardSidebar(
		uiOutput(
			outputId = "countries"
		)
	)
	, dashboardBody(
		box(
			width = 12
  		, mapdeckOutput(
  			outputId = "map"
  		)
		)
		, box(
			width = 12
  		, sliderInput(
  			inputId = "lons"
  			, label = "longitudes"
  			, min = -180
  			, max = 180
  			, value = c(-90, 90)
  		)
		)
	)
)

server <- function(input, output, session) {

	key <- read.dcf("~/Documents/.googleAPI", fields = "MAPBOX")
	dt <- as.data.table(capitals)
	dt[, key := 1]
	dt[lat < 0, hemisphere := "south"]
	dt[lat >= 0, hemisphere := "north"]

	dt_countries <- dt[ country == "United Kingdom of Great Britain and Northern Ireland", .(country_from = country, capital_from = capital, lat_from = lat, lon_from = lon, key)][
		dt[country != "United Kingdom of Great Britain and Northern Ireland" ,  .(country_to = country, capital_to = capital, lat_to = lat, lon_to = lon, hemisphere, key) ]
		, on = "key"
		, allow.cartesian = T
		]

	output$countries <- renderUI({
		selectInput(
			inputId = "countries"
			, label = "Countries"
			, choices = dt[, country]
			, selected = "United Kingdom of Great Britain and Northern Ireland"
		)
	})

	dt_reactive_countries <- reactive({

		if(is.null(input$countries) || is.null(input$lons)) return()

		selected_country <- input$countries
		selected_lons <- input$lons

		dt_countries <- dt[ 
			country == selected_country
			, .(country_from = country, capital_from = capital, lat_from = lat, lon_from = lon, key)][
			dt[
				country != selected_country
				,  .(country_to = country, capital_to = capital, lat_to = lat, lon_to = lon, hemisphere, key) ]
			, on = "key"
			, allow.cartesian = T
			][
				lon_to >= selected_lons[1] & lon_to <= selected_lons[2]
			]
		return(dt_countries)
	})

	output$map <- renderMapdeck({

		if(is.null(dt_countries) || is.null(dt)) return()

		mapdeck(
			token = key
			, style = "mapbox://styles/mapbox/dark-v9"
			, pitch = 35
		) %>%
			add_arc(
				data = dt_countries
				, layer_id = "arc_layer"
				, origin = c("lon_from", "lat_from")
				, destination = c("lon_to", "lat_to")
				, stroke_from = "country_from"
				, id = "country_to"
			) %>%
			add_scatterplot(
				data = dt
				, lat = "lat"
				, lon = "lon"
				, radius = 100000
				, fill_colour = "country"
				, layer_id = "scatter"
			)
	})

	observeEvent({
		c(input$lons, input$countries)
	}, {
		if(is.null(dt_reactive_countries())) return()

		mapdeck_update('map') %>%
			add_arc(
				data = dt_reactive_countries()
				, layer_id = "arc_layer"
				, origin = c("lon_from", "lat_from")
				, destination = c("lon_to", "lat_to")
				, stroke_from = "country_from"
				, id = "country_to"
			)
	})
}
shinyApp(ui, server)

```
